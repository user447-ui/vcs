<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messa: –ù–æ–≤–∞—è –°–æ—Ü. –°–µ—Ç—å!</title>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
    <style>
        #chat {
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 10px;
        }
        .username {
            font-weight: bold;
            color: #4CAF50;
        }
        .audio-message {
            cursor: pointer;
        }
        .image-message {
            max-width: 200px;
        }
    </style>
</head>
<body>
    <p>üîí –°–æ–æ–±—â–µ–Ω–∏–µ –∏ –∑–≤–æ–Ω–∫–∏ –∑–∞—â–∏—â–µ–Ω—ã —Å–∫–≤–æ–∑–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º. –¢—Ä–µ—Ç—å–∏ –ª–∏—Ü–∞, –≤–∫–ª—é—á–∞—è Messa –Ω–µ –º–æ–≥—É—Ç –Ω–∏—á–µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å.</p>
    <p id="encryption-status">‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ</p>

    <div id="chat"></div>

    <label for="username">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è: </label>
    <input type="text" id="username" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—á–µ–Ω–Ω—ã–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç">
    <br><br>

    <input type="text" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <button onclick="startRecording()">–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
    <button onclick="stopRecording()" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>

    <br><br>

    <!-- –î–æ–±–∞–≤–∏–º —Ñ–æ—Ä–º—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <input type="file" id="fileInput" accept="image/*" onchange="sendImage()">
    
    <script>
        const socket = new WebSocket('ws://localhost:8080/ws');
        let aesKey = "TestKey";  // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AES-–∫–ª—é—á
        let username = "";  // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let mediaRecorder;
        let audioChunks = [];

        function encryptMessage(message) {
            return CryptoJS.AES.encrypt(message, aesKey).toString();
        }

        function decryptMessage(encryptedMessage) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedMessage, aesKey);
                return bytes.toString(CryptoJS.enc.Utf8) || "–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏!";
            } catch (e) {
                return "–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏!";
            }
        }

        // –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        sendAudioMessage(audioBlob);
                        audioChunks = [];
                    };
                    mediaRecorder.start();
                    document.querySelector("button[onclick='stopRecording()']").disabled = false;
                })
                .catch(error => {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É!");
                });
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
        function stopRecording() {
            mediaRecorder.stop();
            document.querySelector("button[onclick='stopRecording()']").disabled = true;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendAudioMessage(audioBlob) {
            const formData = new FormData();
            formData.append("audio", audioBlob, "message.wav");
            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Audio = event.target.result.split(",")[1];  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ base64
                const audioMessage = `${username}:audio:${base64Audio}`;
                socket.send(audioMessage);  // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç
            };
            reader.readAsDataURL(audioBlob);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function sendImage() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const base64Image = event.target.result.split(",")[1];  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ base64
                    const imageMessage = `${username}:image:${base64Image}`;
                    socket.send(imageMessage);  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç
                    fileInput.value = "";  // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                };
                reader.readAsDataURL(file);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        socket.onmessage = function(event) {
            const msg = event.data;
            const chat = document.getElementById("chat");
            const messageElement = document.createElement("div");
            messageElement.className = "message";

            const [sender, messageType, content] = msg.split(":");

            if (messageType === "audio") {
                const audioElement = document.createElement("audio");
                audioElement.controls = true;
                audioElement.src = "data:audio/wav;base64," + content;  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ
                messageElement.innerHTML = `<span class="username">${sender}:</span> –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: `;
                messageElement.appendChild(audioElement);
            } else if (messageType === "image") {
                const imageElement = document.createElement("img");
                imageElement.src = "data:image/jpeg;base64," + content;
                imageElement.classList.add("image-message");
                messageElement.innerHTML = `<span class="username">${sender}:</span> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: `;
                messageElement.appendChild(imageElement);
            } else {
                const decryptedMessage = decryptMessage(content);
                messageElement.innerHTML = `<span class="username">${sender}:</span> ${decryptedMessage}`;
            }

            chat.appendChild(messageElement);
        };

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const inputMessage = document.getElementById("message");
            const inputUsername = document.getElementById("username");

            if (inputUsername.value.trim() !== "") {
                username = inputUsername.value.trim();
            } else {
                alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");
                return;
            }

            if (inputMessage.value.trim()) {
                const encrypted = encryptMessage(inputMessage.value);
                const messageToSend = `${username}:text:${encrypted}`;
                socket.send(messageToSend);
                inputMessage.value = "";
            }
        }
    </script>
</body>
</html>